import React, { useState, useEffect } from 'react';
import { 
  FaDatabase, 
  FaSync, 
  FaDownload, 
  FaUpload, 
  FaServer, 
  FaCog, 
  FaShieldAlt,
  FaCheckCircle,
  FaExclamationTriangle,
  FaWifi,
  FaWifiSlash
} from 'react-icons/fa';
import { showToast } from '../components/ToasterHelper';\n\n// Tauri imports (conditionally loaded)\nlet tauriAPI;\nif (window.__TAURI__) {\n  import('@tauri-apps/api').then(module => {\n    tauriAPI = module;\n  });\n}\n\nconst DesktopSettings = () => {\n  const [isDesktop, setIsDesktop] = useState(false);\n  const [connectionStatus, setConnectionStatus] = useState('disconnected');\n  const [syncStatus, setSyncStatus] = useState('idle');\n  const [settings, setSettings] = useState({\n    remoteDatabase: {\n      host: 'web-production-94f67.up.railway.app',\n      port: '443',\n      database: 'railway',\n      username: '',\n      password: '',\n      useSSL: true\n    },\n    sync: {\n      autoSync: true,\n      syncInterval: 30, // minutes\n      lastSync: null,\n      conflictResolution: 'server_wins' // server_wins, client_wins, manual\n    },\n    backup: {\n      autoBackup: true,\n      backupLocation: '',\n      backupSchedule: 'daily', // daily, weekly, monthly\n      retentionDays: 30\n    },\n    security: {\n      encryptData: true,\n      requireAuth: true,\n      sessionTimeout: 60 // minutes\n    }\n  });\n\n  useEffect(() => {\n    setIsDesktop(window.__TAURI__ !== undefined);\n    loadSettings();\n    checkConnectionStatus();\n  }, []);\n\n  const loadSettings = async () => {\n    try {\n      if (isDesktop && tauriAPI?.fs) {\n        // Load settings from local file in desktop mode\n        const savedSettings = localStorage.getItem('desktop_settings');\n        if (savedSettings) {\n          setSettings({...settings, ...JSON.parse(savedSettings)});\n        }\n      }\n    } catch (error) {\n      console.error('Failed to load settings:', error);\n    }\n  };\n\n  const saveSettings = async () => {\n    try {\n      localStorage.setItem('desktop_settings', JSON.stringify(settings));\n      if (isDesktop && tauriAPI?.fs) {\n        // Also save to file system in desktop mode\n        await tauriAPI.fs.writeTextFile('settings.json', JSON.stringify(settings, null, 2));\n      }\n      showToast('Settings saved successfully', 'success');\n    } catch (error) {\n      console.error('Failed to save settings:', error);\n      showToast('Failed to save settings', 'error');\n    }\n  };\n\n  const checkConnectionStatus = async () => {\n    try {\n      const response = await fetch(`https://${settings.remoteDatabase.host}/`, {\n        method: 'GET',\n        timeout: 5000\n      });\n      setConnectionStatus(response.ok ? 'connected' : 'error');\n    } catch (error) {\n      setConnectionStatus('disconnected');\n    }\n  };\n\n  const testConnection = async () => {\n    setSyncStatus('testing');\n    try {\n      const { host, port, useSSL } = settings.remoteDatabase;\n      const protocol = useSSL ? 'https' : 'http';\n      const url = `${protocol}://${host}${port !== '443' && port !== '80' ? `:${port}` : ''}/`;\n      \n      const response = await fetch(url, {\n        method: 'GET',\n        timeout: 10000\n      });\n      \n      if (response.ok) {\n        setConnectionStatus('connected');\n        showToast('Connection successful!', 'success');\n      } else {\n        setConnectionStatus('error');\n        showToast('Connection failed - Server error', 'error');\n      }\n    } catch (error) {\n      setConnectionStatus('disconnected');\n      showToast('Connection failed - Network error', 'error');\n    } finally {\n      setSyncStatus('idle');\n    }\n  };\n\n  const syncData = async () => {\n    setSyncStatus('syncing');\n    try {\n      // Simulate sync process\n      await new Promise(resolve => setTimeout(resolve, 3000));\n      \n      const now = new Date();\n      setSettings(prev => ({\n        ...prev,\n        sync: {\n          ...prev.sync,\n          lastSync: now.toISOString()\n        }\n      }));\n      \n      showToast('Data synchronized successfully', 'success');\n    } catch (error) {\n      showToast('Sync failed', 'error');\n    } finally {\n      setSyncStatus('idle');\n    }\n  };\n\n  const backupData = async () => {\n    if (!isDesktop) {\n      showToast('Backup is only available in desktop mode', 'warning');\n      return;\n    }\n    \n    try {\n      if (tauriAPI?.dialog) {\n        const selected = await tauriAPI.dialog.save({\n          title: 'Save Backup File',\n          defaultPath: `clinic_backup_${new Date().toISOString().split('T')[0]}.json`,\n          filters: [{\n            name: 'JSON',\n            extensions: ['json']\n          }]\n        });\n        \n        if (selected) {\n          // Create backup data\n          const backupData = {\n            timestamp: new Date().toISOString(),\n            version: '1.0.0',\n            data: {\n              // This would contain actual patient data, appointments, etc.\n              placeholder: 'Backup data would be exported here'\n            }\n          };\n          \n          await tauriAPI.fs.writeTextFile(selected, JSON.stringify(backupData, null, 2));\n          showToast(`Backup saved to ${selected}`, 'success');\n        }\n      }\n    } catch (error) {\n      console.error('Backup failed:', error);\n      showToast('Backup failed', 'error');\n    }\n  };\n\n  const restoreData = async () => {\n    if (!isDesktop) {\n      showToast('Restore is only available in desktop mode', 'warning');\n      return;\n    }\n    \n    try {\n      if (tauriAPI?.dialog) {\n        const selected = await tauriAPI.dialog.open({\n          title: 'Select Backup File',\n          multiple: false,\n          filters: [{\n            name: 'JSON',\n            extensions: ['json']\n          }]\n        });\n        \n        if (selected) {\n          const content = await tauriAPI.fs.readTextFile(selected);\n          const backupData = JSON.parse(content);\n          \n          // Validate backup data structure\n          if (backupData.timestamp && backupData.data) {\n            showToast(`Data restored from backup (${backupData.timestamp})`, 'success');\n          } else {\n            showToast('Invalid backup file format', 'error');\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Restore failed:', error);\n      showToast('Restore failed', 'error');\n    }\n  };\n\n  const ConnectionStatusIndicator = ({ status }) => {\n    const statusConfig = {\n      connected: { icon: FaCheckCircle, color: 'text-green-500', bg: 'bg-green-100', label: 'Connected' },\n      disconnected: { icon: FaWifiSlash, color: 'text-red-500', bg: 'bg-red-100', label: 'Disconnected' },\n      error: { icon: FaExclamationTriangle, color: 'text-yellow-500', bg: 'bg-yellow-100', label: 'Error' },\n      testing: { icon: FaWifi, color: 'text-blue-500', bg: 'bg-blue-100', label: 'Testing...' }\n    };\n    \n    const config = statusConfig[status] || statusConfig.disconnected;\n    const IconComponent = config.icon;\n    \n    return (\n      <div className={`flex items-center gap-2 px-3 py-2 rounded-lg ${config.bg}`}>\n        <IconComponent className={`${config.color} animate-pulse`} />\n        <span className={`text-sm font-medium ${config.color}`}>{config.label}</span>\n      </div>\n    );\n  };\n\n  if (!isDesktop) {\n    return (\n      <div className=\"p-6 bg-white rounded-lg shadow-md\">\n        <div className=\"text-center py-8\">\n          <FaDatabase className=\"mx-auto text-6xl text-gray-400 mb-4\" />\n          <h3 className=\"text-xl font-semibold text-gray-600 mb-2\">Desktop Settings</h3>\n          <p className=\"text-gray-500 mb-4\">Advanced database and sync features are only available in desktop mode.</p>\n          <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\n            <p className=\"text-blue-700 text-sm\">\n              <strong>Download the desktop app</strong> to access:\n            </p>\n            <ul className=\"text-blue-600 text-sm mt-2 list-disc list-inside\">\n              <li>Remote database configuration</li>\n              <li>Data synchronization</li>\n              <li>Local backups & restore</li>\n              <li>Offline mode support</li>\n            </ul>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold text-gray-800 flex items-center gap-2\">\n            <FaCog className=\"text-blue-500\" />\n            Desktop Settings\n          </h2>\n          <p className=\"text-gray-600 mt-1\">Manage database connections, synchronization, and backups</p>\n        </div>\n        <div className=\"flex gap-2\">\n          <ConnectionStatusIndicator status={connectionStatus} />\n        </div>\n      </div>\n\n      {/* Remote Database Configuration */}\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\n        <h3 className=\"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2\">\n          <FaServer className=\"text-green-500\" />\n          Remote Database Configuration\n        </h3>\n        \n        <div className=\"grid md:grid-cols-2 gap-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Host</label>\n            <input\n              type=\"text\"\n              value={settings.remoteDatabase.host}\n              onChange={(e) => setSettings(prev => ({\n                ...prev,\n                remoteDatabase: { ...prev.remoteDatabase, host: e.target.value }\n              }))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              placeholder=\"web-production-94f67.up.railway.app\"\n            />\n          </div>\n          \n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Port</label>\n            <input\n              type=\"text\"\n              value={settings.remoteDatabase.port}\n              onChange={(e) => setSettings(prev => ({\n                ...prev,\n                remoteDatabase: { ...prev.remoteDatabase, port: e.target.value }\n              }))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              placeholder=\"443\"\n            />\n          </div>\n          \n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Username</label>\n            <input\n              type=\"text\"\n              value={settings.remoteDatabase.username}\n              onChange={(e) => setSettings(prev => ({\n                ...prev,\n                remoteDatabase: { ...prev.remoteDatabase, username: e.target.value }\n              }))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              placeholder=\"Database username\"\n            />\n          </div>\n          \n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Password</label>\n            <input\n              type=\"password\"\n              value={settings.remoteDatabase.password}\n              onChange={(e) => setSettings(prev => ({\n                ...prev,\n                remoteDatabase: { ...prev.remoteDatabase, password: e.target.value }\n              }))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              placeholder=\"Database password\"\n            />\n          </div>\n        </div>\n        \n        <div className=\"flex items-center mt-4\">\n          <input\n            type=\"checkbox\"\n            checked={settings.remoteDatabase.useSSL}\n            onChange={(e) => setSettings(prev => ({\n              ...prev,\n              remoteDatabase: { ...prev.remoteDatabase, useSSL: e.target.checked }\n            }))}\n            className=\"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded\"\n          />\n          <label className=\"ml-2 text-sm text-gray-700 flex items-center gap-1\">\n            <FaShieldAlt className=\"text-green-500\" />\n            Use SSL/TLS encryption\n          </label>\n        </div>\n        \n        <div className=\"flex gap-2 mt-6\">\n          <button\n            onClick={testConnection}\n            disabled={syncStatus === 'testing'}\n            className=\"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 flex items-center gap-2\"\n          >\n            <FaWifi />\n            {syncStatus === 'testing' ? 'Testing...' : 'Test Connection'}\n          </button>\n          \n          <button\n            onClick={saveSettings}\n            className=\"px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2\"\n          >\n            <FaCog />\n            Save Settings\n          </button>\n        </div>\n      </div>\n\n      {/* Synchronization */}\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\n        <h3 className=\"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2\">\n          <FaSync className=\"text-blue-500\" />\n          Data Synchronization\n        </h3>\n        \n        <div className=\"grid md:grid-cols-3 gap-4 mb-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Auto Sync</label>\n            <label className=\"flex items-center\">\n              <input\n                type=\"checkbox\"\n                checked={settings.sync.autoSync}\n                onChange={(e) => setSettings(prev => ({\n                  ...prev,\n                  sync: { ...prev.sync, autoSync: e.target.checked }\n                }))}\n                className=\"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded\"\n              />\n              <span className=\"ml-2 text-sm text-gray-700\">Enable automatic sync</span>\n            </label>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Sync Interval (minutes)</label>\n            <input\n              type=\"number\"\n              value={settings.sync.syncInterval}\n              onChange={(e) => setSettings(prev => ({\n                ...prev,\n                sync: { ...prev.sync, syncInterval: parseInt(e.target.value) || 30 }\n              }))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              min=\"5\"\n              max=\"1440\"\n            />\n          </div>\n          \n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Conflict Resolution</label>\n            <select\n              value={settings.sync.conflictResolution}\n              onChange={(e) => setSettings(prev => ({\n                ...prev,\n                sync: { ...prev.sync, conflictResolution: e.target.value }\n              }))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            >\n              <option value=\"server_wins\">Server Wins</option>\n              <option value=\"client_wins\">Client Wins</option>\n              <option value=\"manual\">Manual Resolution</option>\n            </select>\n          </div>\n        </div>\n        \n        {settings.sync.lastSync && (\n          <div className=\"bg-gray-50 rounded-lg p-3 mb-4\">\n            <p className=\"text-sm text-gray-600\">\n              <strong>Last Sync:</strong> {new Date(settings.sync.lastSync).toLocaleString()}\n            </p>\n          </div>\n        )}\n        \n        <button\n          onClick={syncData}\n          disabled={syncStatus === 'syncing' || connectionStatus !== 'connected'}\n          className=\"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 flex items-center gap-2\"\n        >\n          <FaSync className={syncStatus === 'syncing' ? 'animate-spin' : ''} />\n          {syncStatus === 'syncing' ? 'Synchronizing...' : 'Sync Now'}\n        </button>\n      </div>\n\n      {/* Backup & Restore */}\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\n        <h3 className=\"text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2\">\n          <FaDatabase className=\"text-purple-500\" />\n          Backup & Restore\n        </h3>\n        \n        <div className=\"grid md:grid-cols-2 gap-4 mb-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Auto Backup</label>\n            <label className=\"flex items-center\">\n              <input\n                type=\"checkbox\"\n                checked={settings.backup.autoBackup}\n                onChange={(e) => setSettings(prev => ({\n                  ...prev,\n                  backup: { ...prev.backup, autoBackup: e.target.checked }\n                }))}\n                className=\"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded\"\n              />\n              <span className=\"ml-2 text-sm text-gray-700\">Enable automatic backups</span>\n            </label>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Backup Schedule</label>\n            <select\n              value={settings.backup.backupSchedule}\n              onChange={(e) => setSettings(prev => ({\n                ...prev,\n                backup: { ...prev.backup, backupSchedule: e.target.value }\n              }))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            >\n              <option value=\"daily\">Daily</option>\n              <option value=\"weekly\">Weekly</option>\n              <option value=\"monthly\">Monthly</option>\n            </select>\n          </div>\n        </div>\n        \n        <div className=\"flex gap-2\">\n          <button\n            onClick={backupData}\n            className=\"px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2\"\n          >\n            <FaDownload />\n            Create Backup\n          </button>\n          \n          <button\n            onClick={restoreData}\n            className=\"px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 flex items-center gap-2\"\n          >\n            <FaUpload />\n            Restore Data\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default DesktopSettings;